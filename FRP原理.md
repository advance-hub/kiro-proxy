# FRP 原理详解

## 1. 为什么需要内网穿透？

你家里或公司的电脑通常在路由器/NAT 后面，没有公网 IP：

```
互联网  ──X──▶  路由器(NAT)  ──▶  你的电脑 192.168.1.100
                 外部无法主动找到你
```

NAT 的特性是：内部可以主动访问外部，但外部无法主动访问内部。FRP 就是利用这个"内部可以主动出去"的特性来反向打通通道。

## 2. 整体架构

```
外部用户  ──请求──▶  公网服务器(frps)  ◀──长连接──  内网机器(frpc)
                        │                              │
                        └──────── 数据转发 ─────────────┘
```

- **frps（服务端）**：部署在有公网 IP 的服务器上
- **frpc（客户端）**：部署在内网机器上，主动连接 frps

## 3. 建立控制通道

frpc 启动时，主动向 frps 发起 TCP 连接：

```
frpc(内网) ────主动连接 TCP────▶ frps(公网:7000)
              │
              ├─ 发送认证信息（auth.token）
              ├─ 注册代理规则（比如：HTTP 类型，本地端口 3000）
              └─ 保持心跳，维持长连接不断开
```

这条连接叫"控制通道"（control connection），它一直活着，双方可以随时互发消息。因为是内网主动发起的，NAT 会记住这条连接，允许双向通信。

## 4. 外部请求的完整流程

以 HTTP 穿透为例，假设你本地跑了个服务在 `localhost:3000`：

```
步骤1: 用户浏览器访问 http://你的服务器IP:8080/v1
       │
步骤2: frps 监听 8080 端口，收到这个 HTTP 请求
       │
步骤3: frps 通过控制通道通知 frpc："有新请求来了，需要建立数据通道"
       │
步骤4: frpc 收到通知，主动向 frps 发起一条新的 TCP 连接（数据通道/proxy connection）
       │
步骤5: frps 把用户的 HTTP 请求数据，通过这条数据通道转发给 frpc
       │
步骤6: frpc 收到数据后，在本地向 localhost:3000 发起请求
       │
步骤7: localhost:3000 返回响应给 frpc
       │
步骤8: frpc 把响应通过数据通道发回 frps
       │
步骤9: frps 把响应返回给用户浏览器
```

整个过程对用户来说是透明的，感觉就像直接访问了公网服务器上的服务。

## 5. 控制通道 vs 数据通道

FRP 用了两种连接：

| | 控制通道 | 数据通道 |
|---|---|---|
| 数量 | 1 条，始终保持 | 每个请求建一条（或复用连接池） |
| 用途 | 认证、注册代理、心跳、通知新请求 | 传输实际的业务数据 |
| 生命周期 | frpc 启动到退出 | 请求结束就关闭（或归还连接池） |

为了性能，frpc 可以配置 `transport.poolCount` 预先建好一批数据通道放在池子里，新请求来了直接用，省去建连的延迟。

## 6. 不同代理类型

| 类型 | 原理 | 场景 |
|---|---|---|
| TCP | frps 监听一个指定端口，所有流量直接转发 | SSH、数据库、任意 TCP 服务 |
| UDP | 同上，但走 UDP 协议 | 游戏、DNS |
| HTTP | frps 监听 `vhostHTTPPort`，根据 Host 头/URL 路由到不同 frpc | Web 服务，支持多个域名共用一个端口 |
| HTTPS | 类似 HTTP，但基于 TLS SNI 路由 | HTTPS 服务 |
| STCP/XTCP | 点对点穿透，frps 只做握手，数据直接 P2P 传输 | 对延迟敏感、不想走服务器中转 |

## 7. 心跳与断线重连

```
frpc ──heartbeat(每30s)──▶ frps
frpc ◀──heartbeat response── frps

如果连续几次心跳没响应：
  frpc 判定连接断开 → 自动重连 → 重新注册代理
```

这保证了网络抖动时服务能自动恢复。

## 8. 安全机制

- **auth.token**：frpc 连接时必须带正确的 token，防止别人滥用你的 frps
- **TLS 加密**：可以开启 `transport.tls.enable = true`，控制通道和数据通道都走加密
- **带宽限制**：可以给每个代理配限速，防止被刷爆
- **端口白名单**：frps 可以限制允许映射的端口范围

## 总结

FRP 的本质就是内网机器主动连到公网服务器，建立一条"反向隧道"，外部请求通过这条隧道到达内网，绕过了 NAT 的限制。
